# V1.1 Features (Should Have)

These features add polish and security to the MVP. They can be delayed if the MVP timeline is at risk, but should be completed before public launch.

---

## 1. Spending Trends (Charts)

**Status:** Not Started  
**Estimated Time:** 4-6 hours  
**Dependencies:** Recharts library

A line graph showing "Joint Spending" over the last 3 months.

**Implementation:**

- Install: `npm install recharts`
- Create component: `/components/SpendingTrendsChart.tsx`
- Query transactions grouped by month
- Display using Recharts LineChart

---

## 2. Recurring Bill Detective

**Status:** Not Started  
**Estimated Time:** 3-4 hours  
**Dependencies:** None

Simple logic to flag transactions that happen every month (e.g., Netflix, Rent).

**Implementation:**

- Query transactions with same merchant_name and similar amount
- Check if they occur monthly (Â±3 days)
- Display in "Upcoming Bills" section on dashboard
- Algorithm: Compare last 3 months of data

---

## 3. Budget Progress Bars

**Status:** Not Started  
**Estimated Time:** 4-5 hours  
**Dependencies:** None

Users can set monthly budget limits for each category. Visual progress bars show spending against the limit and turn red when exceeded.

**Database Changes:**

```sql
CREATE TABLE public.budgets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  household_id UUID NOT NULL REFERENCES public.households(id) ON DELETE CASCADE,
  category_id UUID NOT NULL REFERENCES public.categories(id) ON DELETE CASCADE,
  monthly_limit DECIMAL(10, 2) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  UNIQUE(household_id, category_id) -- One budget per category per household
);
```

**Implementation:**

- Create budgets management UI
- Calculate current month spending per category
- Show progress bar: (current_spending / monthly_limit) \* 100
- Red color when exceeded

---

## 4. Transaction History/Filtering

**Status:** Not Started  
**Estimated Time:** 3-4 hours  
**Dependencies:** None

Ability to filter transactions by date range, category, or personal/joint.

**Implementation:**

- Add filter UI with dropdowns:
  - Date range (This Month, Last Month, Last 3 Months, Custom)
  - Category (All, Groceries, Dining, etc.)
  - Type (All, Personal, Joint)
- Update transaction query with WHERE clauses
- Add search by merchant name

---

## 5. Household Settings Page

**Status:** Not Started  
**Estimated Time:** 2-3 hours  
**Dependencies:** None

A page to manage household configuration.

**Features:**

- Change household name
- Regenerate invite code (if implementing single-use codes)
- View partner profile
- Disconnect bank accounts
- Delete household (with confirmation)
- Leave household

**Route:** `/dashboard/settings`

---

## 6. Goal Auto-Sync

**Status:** Not Started  
**Estimated Time:** 4-6 hours  
**Dependencies:** Plaid account balance API

Goals automatically update progress by tracking balance changes in a linked savings account.

**Implementation:**

- Add field to goals table: `linked_account_id TEXT` (Plaid account ID)
- In goal creation/edit, allow selecting a savings account
- Create cron job or webhook to fetch account balance daily
- Update `current_amount` based on balance
- Show "Last synced: 2 hours ago" in UI

**Complexity:** Higher due to Plaid integration

---

## 7. "Hide from Partner" Toggle (DOCUMENTED FROM ISSUE #9 REVIEW)

**Status:** Not Started  
**Estimated Time:** 3-4 hours  
**Dependencies:** None

Users can mark individual transactions as private to hide them from their partner (e.g., surprise gifts).

**Database:** Already has `is_hidden` column âœ…

**Implementation:**

1. **RLS Policy (Keep Simple - Allow Partner to See Row):**

```sql
   -- DO NOT modify existing RLS policy
   -- Keep it as: "Users can view all household transactions"
   -- We'll handle hiding at the application layer, not database layer
```

**Why?** If RLS hides the row completely, the partner can't see it at all, which breaks the "Ghost Math" balance calculation. We need the row visible so the amount counts toward the total.

2. **Application-Level Masking (Frontend/Backend):**

   **Backend (API Route or Server Component):**

```typescript
const { data: transactions } = await supabase
  .from("transactions")
  .select("*")
  .eq("household_id", householdId);

// Mask transactions that are hidden and not yours
const maskedTransactions = transactions.map((txn) => {
  if (txn.is_hidden && txn.user_id !== currentUserId) {
    return {
      ...txn,
      merchant_name: "[Private Transaction] ðŸ”’",
      description: "[Private Transaction]",
      category_id: null, // Don't reveal category
    };
  }
  return txn;
});
```

**Frontend:**

```typescript
<TransactionRow
  merchant={
    transaction.is_hidden && transaction.user_id !== currentUserId
      ? "[Private Transaction] ðŸ”’"
      : transaction.merchant_name
  }
  amount={transaction.amount} // Always visible
  date={transaction.date} // Always visible
/>
```

3. **Add Toggle Button:**

   - On each transaction card: "Hide from Partner" toggle
   - Update `is_hidden` column when toggled
   - Show confirmation: "This will hide merchant details from your partner. Amount and date remain visible."

**Critical Implementation Note:**

- Do NOT use RLS to hide rows completely (breaks balance calculation)
- Instead: RLS allows partner to see the row, but application logic masks sensitive fields
- Partner still sees: amount, date, "is_joint" status
- Partner does NOT see: merchant_name, description, category (if hidden)
- This preserves the "Ghost Math" fix from your PRD

- **Merchant Masking Logic:**
  - If `is_hidden = true` AND `user_id != auth.uid()`:
    - Display: "[Private Transaction] ðŸ”’"
    - Hide: merchant_name, category
    - Show: amount, date
  - This preserves "Net Worth" accuracy (Ghost Math Fix)

**UI Flow:**

1. User clicks "Hide from Partner" on transaction
2. Confirmation modal: "This will hide the merchant details from your partner. The amount and date will still be visible."
3. Update `is_hidden = true`
4. Partner sees: "-$100 [Private Transaction] ðŸ”’ - Personal"

---

## 8. Single-Use Invite Codes (DOCUMENTED FROM ISSUE #9 REVIEW)

**Status:** Not Started  
**Estimated Time:** 2-3 hours  
**Dependencies:** None

Household invite codes can only be used once for security.

**Database Changes:**

```sql
ALTER TABLE public.households
ADD COLUMN invite_used_at TIMESTAMPTZ,
ADD COLUMN invite_used_by UUID REFERENCES public.users(id);
```

**Implementation:**

1. When user joins via `/join/[code]`:

```typescript
// Check if code already used
if (household.invite_used_at) {
  redirect("/invite-already-used");
}

// Mark as used when joining
await supabase
  .from("households")
  .update({
    invite_used_at: new Date().toISOString(),
    invite_used_by: user.id,
  })
  .eq("id", household.id);
```

2. Add "Regenerate Invite Code" button in Household Settings:

```typescript
const newCode = "JOIN-" + generateRandomString(6);
await supabase
  .from("households")
  .update({
    invite_code: newCode,
    invite_used_at: null,
    invite_used_by: null,
  })
  .eq("id", household.id);
```

**Benefits:**

- Prevents random people from joining if code leaks
- Limits household to exactly 2 people
- Better security hygiene

**Error Messages:**

- "This invite code has already been used. Ask your partner to generate a new one."

---

## 9. Robust Plaid Error Handling (Deferred from #21)

**Status:** Not Started  
**Estimated Time:** 3-4 hours  
**Dependencies:** Plaid webhooks (optional)

Advanced error handling for Plaid integration beyond basic try/catch.

**Features to Implement:**

1. **Re-authentication Flow:**

   - Detect `ITEM_LOGIN_REQUIRED` error
   - Update `linked_accounts.status = 'reauth_required'`
   - Show "Reconnect" button on dashboard
   - Use Plaid Link in "update mode" to re-authenticate
   - Reset status to `active` on success

2. **Reconnect Button:**

```typescript
// Plaid Link update mode
const { open } = usePlaidLink({
  token: linkToken,
  onSuccess: handleReconnectSuccess,
});
```

3. **Error Code Handling:**
   | Error Code | Action |
   |------------|--------|
   | `ITEM_LOGIN_REQUIRED` | Show reconnect button |
   | `INSTITUTION_NOT_RESPONDING` | Show "try again later" message |
   | `INVALID_CREDENTIALS` | Prompt to re-link |
   | `PRODUCT_NOT_READY` | Show "check back soon" message |

**Implementation Notes:**

- Consider Plaid webhooks for real-time error detection
- May need to poll `/item/get` endpoint periodically
- Log errors to analytics for monitoring

**What Was Completed in Phase 2:**

- âœ… Basic error handling (try/catch with user messages)
- âœ… Loading states during linking and syncing
- âœ… Last synced timestamp display
- âœ… Unlink account functionality

---

## Priority Order (Recommended)

1. **Transaction History/Filtering** (Essential for usability)
2. **Budget Progress Bars** (High value, moderate effort)
3. **Household Settings Page** (Important for household management)
4. **Spending Trends Chart** (Visual appeal for demos)
5. **Hide from Partner Toggle** (Nice to have for privacy)
6. **Single-Use Invite Codes** (Security improvement)
7. **Recurring Bill Detective** (Lower priority, can be V2.0)
8. **Goal Auto-Sync** (Complex, can be V2.0)

---

## Notes

- These features build on the MVP foundation
- Each is independent and can be built in any order
- Prioritize based on beta user feedback (Feb 1-15)
- If timeline is tight, move lower-priority items to V2.0
